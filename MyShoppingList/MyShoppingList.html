<!DOCTYPE html>
<html>
  <head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>My Shopping List</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  </head>
  <body>
  
    <h1>My Shopping List</h1>
	<br>
	<div id="data" >
      <div class="input-form">
        <div style="text-align: center;">
          <p>Enter Your Item:</p>
        </div>
        <form id="shoppingListForm" action="javascript:insert_value()" >
		  <label for="itName">Item:</label><br>
	      <input type="Text" id="itName" name="ItemName" placeholder="Your Item Name..." style="width:textFieldWidth" required><br>
	    
		  <label for="itQuantity">Quantity:</label><br>
	      <input type="Number" id="itQuantity" name="ItemQuantity" placeholder="How Many?" style="width:textFieldWidth" required><br>
	    
	      <label for="itPrice">Price in &#36;:</label><br>
	      <input type="Number" id="itPrice" name="ItemPrice" placeholder="10 &#36;" style="width:textFieldWidth" required step="any"><br>
	    
	      <br>
          <div class="submit-button">
            <input type="submit" value="Submit">
          </div>
        </form>
      </div>
	</div>
    
    <br>
    
    <div id="currentList" class="current-list">
      <div>
		<form id="showCurrentListForm" action="javascript:readData()" >
		  <input id="showCurrentListBtn" type="submit" value="Show List">
		</form>
      </div>
      <br>
      <div id="tableDiv">
        <table id="listTable" class="current-list-table">
	      <thead>
	      </thead>
          <tbody>
	      </tbody>
	    </table>
      </div>
      
    </div>
    
  </body>
</html>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzmswK3jizZzwrYVhvo69P8cTA8qB1fL3pmqTUdc2-1po2YRklp/exec";
  
  function googleSheetRequestAPI(crossDomain , requestString , method , dataType , callbackFunc) {
	var callbackStr = "?callback="+callbackFunc;
	var url = SCRIPT_URL + callbackStr + requestString;
	var request = jQuery.ajax({
		crossDomain: crossDomain,
		url: url,
		method: method,
		dataType: dataType
    });
  }
  
  function insert_value() {
	var action = 'insert';
	var itemNameVal = $("#itName").val();
	var itemQuantityVal = $("#itQuantity").val();
	var itemPriceVal = $("#itPrice").val();
	
	if(itemNameVal && itemQuantityVal && itemPriceVal)
	{
	  var crossDomain = true;
	  var method = "GET";
	  var dataType = "jsonp";
	  var callbackFunc = "insertCallBack";
	  
	  var requestString =  "&ItemName=" + itemNameVal + 
						   "&ItemQuantity=" + itemQuantityVal + 
						   "&ItemPrice=" + itemPriceVal + 
						   "&Action=" + action;
	  
	  googleSheetRequestAPI(crossDomain , requestString, method, dataType , callbackFunc);
	  document.getElementById("shoppingListForm").reset();
	}
	else
	{
	  alert('All fields must be completed1.');
	}
	
  }
  
  function readData() {
	alert('Reading Data...');
	var crossDomain = true;
    var method = "GET";
    var dataType = "jsonp";
	//var columnToRead = "all";
	var columnToRead = "ItemName,ItemQuantity,ItemPrice,TimeStamp";
	var action = "read";
	var callbackFunc = "readCallBack";
	
	var requestString = "&columnsToRead=" + columnToRead +
						"&Action=" + action;
						
						
	googleSheetRequestAPI(crossDomain , requestString , method , dataType , callbackFunc);
  }
  
  
  function insertCallBack(returnedInsertResult) {
	var insertResult = returnedInsertResult.insertResult
	if(insertResult == false) {alert("Failed:\n"+returnedInsertResult.moreInfo) }
	else {
		alert("Success:\n"+returnedInsertResult.moreInfo);
	}
	
  }
  
  function readCallBack(returnedReadResult) {
	if(returnedReadResult.ItemName !== null) {
		repopulateListTable(returnedReadResult);
	} else {
		alert("Error - Returned readCallBack parameter is null");
	}
  }
  
  
  function showCurrentList() {
	toggleShowCurrentListBtnText();
	
  }
  
  
  
  function toggleShowCurrentListBtnText() {
    var showCurrentListBtn = $("#showCurrentListBtn");
    var currentShowListButtonText = showCurrentListBtn.val();
	var newShowListButtonText = 'Show List';
	if(currentShowListButtonText == 'Show List') {
	  newShowListButtonText = 'Hide List';
	}
	alert('Current Text = '+currentShowListButtonText +'\nChanging to: '+newShowListButtonText);
	showCurrentListBtn.val(newShowListButtonText);
	
  }
  
  
  function repopulateListTable(returnedReadResult) {
	var validateResult = validateReturnedResults(returnedReadResult);
	if(validateResult[0] == false) { 
		alert(validateResult[1]);
		return
	}
    var listTable = $("#listTable");
	var headers = returnedReadResult.columnNames
	
	populateHeaderRows(listTable,headers);
	populateDataRows(listTable , returnedReadResult);
	createRemoveSelectedRowsButton();
  }
  
  function validateReturnedResults(returnedReadResult) {
	if((returnedReadResult.columnNames) == null) {return [false , "Results.columnNames property is null"]}
	if((returnedReadResult.data) == null) {return [false , "Results.data property is null"]}
	var columnCount = returnedReadResult.columnNames.length
	if(columnCount == 0) {return [false , "Results.columnNames property is of count 0 (contains no column names)"]}
	
	var dataLength = countInObject(returnedReadResult.data)
	if(columnCount != dataLength) {return [false , "Results.columnNames and Results.Data properties are of different lengths"]}
	
	var firstColumnName = returnedReadResult.columnNames[0]
	var firstColumnLength = returnedReadResult.data[`${firstColumnName}`].length
	// Checking all columns are of the same length:
	for(var i = 1; i < returnedReadResult.columnNames.length; i++) {
		var curColumnName = returnedReadResult.columnNames[i]
		var curColumnLength = returnedReadResult.data[`${curColumnName}`].length
		
		if(firstColumnLength != curColumnLength) {
			return [false , "Results.columnNames property contains columns (0 and "+`${i}`+") " +
				"of different lengths ("+`${firstColumnLength}` +","+`${curColumnLength}`+")"]
		}		
	}
	
	// All Good
	return [true , "Returned results are ok"]
  }
  
  function populateHeaderRows(table,headers) {
	var tableHeader = table.find('thead');	
	
	var newHead = document.createElement('thead');
	var newRowElement = document.createElement('tr');
	
	// Special Case - Create Header for checkbox column:
	var headerRowElement = document.createElement('th');
	//headerRowElement.innerHTML = " All ";
	var checkboxElement = document.createElement('input');
	checkboxElement.setAttribute("type" , "checkbox");
	checkboxElement.setAttribute("id" , "checkboxHeader");
	checkboxElement.setAttribute("onclick" , "checkUncheckAllRowsInTable()");
	headerRowElement.appendChild(checkboxElement);
	newRowElement.appendChild(headerRowElement);
	
	
	// Create <th> element for every column name
	for(var i = 0 ; i < headers.length; i++) {
		var headerRowElement = document.createElement('th');
		headerRowElement.innerHTML = headers[i].toString();
		newRowElement.appendChild(headerRowElement);
	}
	
	newHead.appendChild(newRowElement);
	tableHeader[0].parentNode.replaceChild(newHead , tableHeader[0]);
	
	
  }
  
  function populateDataRows(table , returnedReadResult) {
	var data = returnedReadResult.data
	var columnNames = returnedReadResult.columnNames
	// Get length of first column - all columns should be the same length anyway
	var columnsLength = data[`${columnNames[0]}`].length
	
	var oldBody = table.find('tbody');
	var newBody = document.createElement('tbody');
	
	for(var index = 0 ; index < columnsLength; index++) {
		var newBodyRowElement = createNewDataRowFromIndex(index , columnNames , data);
		newBody.appendChild(newBodyRowElement);
	}
	
	oldBody[0].parentNode.replaceChild(newBody , oldBody[0]);
	
  }
  
  function createNewDataRowFromIndex(index , columnNames , data) {
	var newRowElement = document.createElement('tr');
	
	// Create Checkbox element for the row:
	var newDataElement = document.createElement('td');
	var checkboxElement = document.createElement('input');
	checkboxElement.setAttribute("type", "checkbox");
	checkboxElement.setAttribute("class", "checkboxRow");
	newDataElement.appendChild(checkboxElement)
	newRowElement.appendChild(newDataElement)
	
	for(var j = 0 ; j < columnNames.length; j++) {
		var newDataElement = document.createElement('td');
		var curColumnName = columnNames[j]
		var dataValue = data[`${curColumnName}`][index]
		
		newDataElement.innerHTML = dataValue.toString()
		newRowElement.appendChild(newDataElement)
	}
	
	return newRowElement;
  }
  
  function countInObject(obj) {
    var count = 0;
    // iterate over properties, increment if a non-prototype property
    for(var key in obj) if(obj.hasOwnProperty(key)) count++;
    return count;
  }
  
  function createRemoveSelectedRowsButton() {
	var tableDiv = document.getElementById('tableDiv')
	// Create Remove Button Row:
	var removeBtnElement = document.createElement('input');
	removeBtnElement.setAttribute("type" , "button");
	removeBtnElement.setAttribute("value" , " Remove Selected ");
	tableDiv.appendChild(removeBtnElement);
  }
  
  //function checkAllRowsInTable() {
	//var listTable = $("#listTable");
	//var tableBody = table.find('tbody');
	//var allRows = tableBody.find('td');
	//for(
  //}
  
  function checkUncheckAllRowsInTable() {
	//alert("yes");
	var checkboxHeader = $('#checkboxHeader')
	if (checkboxHeader.checked == false) {
	  $('.checkboxRow').attr('checked', false);
	}
	else {
	  $('.checkboxRow').attr('checked', true);
	}
  }
  //$('#checkboxHeader').click(function () {
  //});
  
  
	
</script>

<style>
   body {
     background-color: LightSeaGreen;
     text-align: center;
  }
  
  
  .input-form {
    text-align: left;
    display: inline-block;
    background-color: LightBlue;
    border: 12px solid LightBlue;
  }
  
  .submit-button{
    text-align: center;
  }
  
  .current-list{
    display: inline-block;
    text-align: left;
    border: 1px solid;
    width: 50%;
  }
  
  .current-list-table {
    width: 100%;
    border: 2px solid black;
    text-align: left;
    background-color: #f1f1c1;
  }
  
  th , td {
	border: 1px solid black;
  }
</style>